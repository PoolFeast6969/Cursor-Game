<!DOCTYPE html>
<html lang="en">

	<head>
		{% load staticfiles %}
		<link rel="stylesheet" href="{% static "the.css" %}" />
		<script src="{% static "jquery-1.11.1.min.js" %}"></script>
		<script src="{% static "omnibus.min.js" %}"></script>
	</head>

	<body>
		<script type="text/javascript">
			(function() {
				// Initialize connection:
				var players = {};
				var transport = WebSocket;
				var endpoint = '{{ OMNIBUS_ENDPOINT }}';
				var options = {authToken: '{{ OMNIBUS_AUTH_TOKEN }}'};
				var connection = new Omnibus(transport, endpoint, options);
				var channel = connection.openChannel('mousemoves');

				connection.on(Omnibus.events.CONNECTION_CONNECTED, function(event) {
					$('.connection').addClass('open').text('Yes');
				}).on(Omnibus.events.CONNECTION_AUTHENTICATED, function(event) {
					$('.identification').addClass('open').text('Yes');
				});
				channel.on(Omnibus.events.CHANNEL_SUBSCRIBED, function(event) {
					$('.channel').addClass('open').text('Yes');
				}).on('move', function(event) {
					var player = players[event.data.sender];
					if (player === undefined) {
						player = $('<div class="player" />').appendTo($('body'));
						players[event.data.sender] = player;
					}
					player.css({
						top: event.data.payload.top,
						left: event.data.payload.left
					});
				}).on('disconnect', function(event) {
					var player = players[event.data.sender];
					if (player !== undefined) {
						player.remove();
						players[event.data.sender] = undefined;
						delete(players[event.data.sender]);
					}
				});

				$('body').mousemove(function(e) {
					channel.send('move', {
						top: e.pageY,
						left: e.pageX
					});
				});
			})();
		</script>
		<dl>
			<dt>Connected</dt>
			<dd class="state connection">No</dd>
			<dt>Identified</dt>
			<dd class="state identification">No</dd>
			<dt>Channel subscribed</dt>
			<dd class="state channel">No</dd>
		</dl>
	</body>

</html>
