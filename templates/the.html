<!DOCTYPE html>
<html lang="en">

	<head> {% load staticfiles %}
		<link rel="stylesheet" href="{% static "the.css" %}" />
		<script src="{% static "jquery-1.11.1.min.js" %}"></script>
		<script src="{% static "omnibus.js" %}"></script>
	</head>

	<body>
		<script type="text/javascript">
			String.prototype.format = function() {
				var args = arguments;
				return this.replace(/{(\d+)}/g, function(match, number) {
					return typeof args[number] != 'undefined' ? args[number] : match;
				});
			};
			function player(id, username) {
				this.id = id;
				this.username = username;
				this.html = $($('#player').html().format(username)).appendTo($('body'));
			}
			player.prototype.move = function(top, left) {
				this.html.css({
					top: top,
					left: left
				});
			};
			game = {};
			(function() {
				var transport = WebSocket;
				var endpoint = '{{ OMNIBUS_ENDPOINT }}';
				var options = {
					ignoreSender: false,
					authToken: '{{ OMNIBUS_AUTH_TOKEN }}'
				};
				var connection = new Omnibus(transport, endpoint, options);
				var channel = connection.openChannel('mousemoves');
				var clientid = '{{ request.session.id }}'

				channel.on(Omnibus.events.CHANNEL_SUBSCRIBED, function(event) {
					console.log('Channel Subscribed');
				}).on('move', function(event) {
					game['player'+event.data.sender].move(event.data.payload.top, event.data.payload.left);
				}).on('update', function(event) {
					var newgame = $.map(event.data.payload, function(value, index) {
						return [value];
					});
					console.log(newgame)
					var serverids = $.map(newgame, function(value, index) {
						return newgame[index]['id'];
					});
					var clientids = $.map(game, function(value, index) {
						return game[index]['id'];
					});
					var add = $(serverids).not(clientids).get();
					$.each(add, function(index, value) {
						game['player'+value] = new player(value, newgame[index]['username']);
					});
					var remove = $(clientids).not(serverids).get();
					$.each(remove, function(index, value) {
						game['player'+value].html.remove();
						delete game['player'+value];
					});
				}).on('chat', function(event) {
					message = event.data.payload['message'];
					$('.chatbox').append($('#chatline').html().format(message));
				});
				$('body').mousemove(function(e) {
					channel.send('move', {
						top: e.pageY / $('body').height() * 100 + '%',
						left: e.pageX / $('body').width() * 100 + '%'
					});
				});
			})();

		</script>
		<template id="player">
			<div class="player">
				<img src="{% static "pepe.png" %}">
				<div class="caption">{0}</div>
			</div>
		</template>
		<template id="chatline">
			<div class="chatline">{0}</div>
		</template>
		<div class="chatbox"></div>
	</body>

</html>
