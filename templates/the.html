<!DOCTYPE html>
<html lang="en">

	<head>
		{% load staticfiles %}
		<link rel="stylesheet" href="{% static "the.css" %}" />
		<script src="{% static "jquery-1.11.1.min.js" %}"></script>
		<script src="{% static "omnibus.js" %}"></script>
	</head>

	<body>
		<script type="text/javascript">
		String.prototype.format = function() {
		  var args = arguments;
		  return this.replace(/{(\d+)}/g, function(match, number) {
		        return typeof args[number] != 'undefined'
		          ? args[number]
		          : match
		        ;
		  });
		};

		var player = function (id, username, top, left) {
			console.log('player instance created');
			this.id = id;
			this.username = username;
			this.top = top;
			this.left = left;
		}
		function chatlog(message) {
			console.log(message);
			$('.chatbox').append($('#chatline').html().format(message));
		}

		function updategame(game) {
			window.game = $.map(game, function(value, index) {
			    return [value];
			});
		}

		(function() {
			var transport = WebSocket;
			var endpoint = '{{ OMNIBUS_ENDPOINT }}';
			var options = {authToken: '{{ OMNIBUS_AUTH_TOKEN }}'};
			var connection = new Omnibus(transport, endpoint, options);
			var channel = connection.openChannel('mousemoves');
			var id = '{{ request.session.id }}'

			connection
				.on(Omnibus.events.CONNECTION_CONNECTED, function(event) {
					console.log('Connection Created');
				})
				.on(Omnibus.events.CONNECTION_AUTHENTICATED, function(event) {
					console.log('Connection Authenticated');
				});

			channel
				.on(Omnibus.events.CHANNEL_SUBSCRIBED, function(event) {
					console.log('Channel Subscribed');
				})
				.on('move', function (event) {
					id =  event.data.sender
					if (player.id.move(event)) {
						var player =  window.game.some(function (obj) {
						  	if (obj.id === this.id) {
								return obj;
						  	}
						});
					}
				})
				.on('connect', function (event) {
					updategame(event.data.payload);
				})
				.on('disconnect', function (event) {
					updategame(event.data.payload);
				})
				.on('chat', function (event) {
					message = event.data.payload[null];
					chatlog(message);
				});

			$('body').mousemove(function(e) {
				channel.send('move', {top: e.pageY/$('body').height()*100+'%', left: e.pageX/$('body').width()*100+'%', 'id': id});
			});
		})();
		</script>

		<template id="player">
			<div class="player">
				<img src="{% static "pepe.png" %}">
				<div class="caption">{0}</div>
			</div>
		</template>
		<template id="chatline">
			<div class="chatline">{0}</div>
		</template>

		<div class="chatbox"></div>
	</body>

</html>
